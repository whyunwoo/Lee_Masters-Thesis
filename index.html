<!DOCTYPE html>
<html lang="en">

<head>
    <title>Perceptions of Spaces</title>
    <meta charset="UTF-8">

    <!---- STYLESHEETS ---->
    <link rel="stylesheet" href="assets/css/jspsych.css">
    <link rel="stylesheet" href="assets/css/bootstrap-alart.css">
    <link rel="stylesheet" href="assets/css/jsPsych-padding.css">
    <link rel="stylesheet" href="assets/css/jsPsych-text-edits.css">
    <link rel="stylesheet" href="assets/css/center.css">
    <link rel="stylesheet" href="assets/css/MiSL.css">
    <link rel="stylesheet" href="assets/css/survey.css"> 
    <link rel="stylesheet" href="https://unpkg.com/@jspsych/plugin-survey@0.2.2/css/survey.css">
    

    <!---- SCRIPTS ---->
    <script src="https://unpkg.com/jspsych@7.2.3"></script>
    <script src="lib/jspsych-7-pavlovia-2022.1.1.js"></script>

    <script src="assets/scripts/groups.js"></script>
    <script src="assets/scripts/firebase.js"></script>
    <script src="assets/scripts/jquery-3.6.0.min.js"></script>
    <script src="assets/scripts/script.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/underscore@1.13.1/underscore-umd-min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- PLUGINS -->
    <script src="https://unpkg.com/@jspsych/plugin-browser-check@1.0.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-image-button-response@1.1.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey@0.2.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@1.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-likert@1.1.3"></script>
    <script src="assets/scripts/plugin-html-slider-response.js"></script>
    <script src="assets/scripts/jspsych-html-mouse-response.js"></script>

    <script src="https://unpkg.com/jspsych@7.3.4"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body></body>

<script>
    
    // Initialize jsPsych
    var jsPsych = initJsPsych({
        use_webaudio: false,
        on_finish: function(data) {
            window.location.assign("https://app.prolific.com/submissions/complete?cc=C1IYJVLI");
        }
    });

    var timeline = [];

    // Prolific Integration
    var subject_id = jsPsych.data.getURLVariable("PROLIFIC_PID"); // Prolific ID for Subject Pool
    var study_id = jsPsych.data.getURLVariable('STUDY_ID');
    var session_id = jsPsych.data.getURLVariable('SESSION_ID');

    jsPsych.data.addProperties({
        subject_id: subject_id,
        study_id: study_id,
        session_id: session_id
    });
    // create pavlovia participant ID --> when need to open this on chorme comment out all the chuncks with pavlovia
    var pavlovia_id = '_p-' + subject_id + '_s-' + session_id; //'c-' + group + '_p-' + subject_id + '_s-' + session_id;

    // GENERATING STIMULI_ARRAY
    const group = `${Math.floor(Math.random() * 2) + 1}`; 
    console.log(`Group : ${group}`);

    let clusterNumbers = shuffleArray([...Array(6).keys()].map(i => `${i + 1}`)); 
    console.log(`Cluster : ${clusterNumbers}`);

    let stimuliArrays = [];
    clusterNumbers.forEach(clusterNumbers => {
        let country = shuffleArray(['1', '2', '3', '4']); 
        country.forEach(country => {
            let filePaths = groups[group][clusterNumbers][country];                                  // bring all 10 images from on state
            let shuffledFilePaths = shuffleArray(filePaths);
            stimuliArrays.push({ clusterNumbers, country, stimuli: shuffledFilePaths });
        });
    });

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }
    console.log("Stimuli arrays:", stimuliArrays);
    
    flat_stimuli_array = [];                        // Initialize an empty array to store the flattened stimuli.
    for (let item of stimuliArrays) {               // Iterate over each item in the stimuliArrays. Each item represents a set of stimuli associated with a specific condition and state.
        for (let stimulus of item.stimuli) {        // Iterate over each stimulus in the current item's stimuli array. This inner loop goes through the individual stimuli (image paths) and adds them to the flat_stimuli_array.
            flat_stimuli_array.push(stimulus);      // Add each stimulus (image path) to the flat_stimuli_array, resulting in a single-level array of all stimuli.
        }
    }

    // ADD INFORMATION OF TRIALS TO THE FINAL DATA
    let data = [];
    stimuliArrays.forEach(item => {                 // Iterate over each item in the stimuliArrays. Each item contains information about a set of stimuli for a given condition and state.
        let trialData = {                           // Construct a trialData object containing details for a single trial. This includes the overall condition, the pair in the condition, the state, and the array of stimuli.
            condition: group,
            clusterNumbers: item.cluster,
            country: item.country,
            stimuli_array: item.stimuli
        };
        data.push(trialData);
    });
    console.log("Data:", data);



/****** INITIALIZE EXPERIMENT ******
************************************
************************************
************************************
************************************/
    
    var pavlovia_id = 's-' + condition + '_p-' + subject_id + '_s-' + session_id;

    var pavlovia_init = {
        type: jsPsychPavlovia,
        data: {
            task: 'pavlovia-init'
        },
        command: "init"
    };
    timeline.push(pavlovia_init);
    

/********* START EXPERIMENT ********
************************************
************************************
************************************
************************************/

    var browserCheck = {
        type: jsPsychBrowserCheck,
        data: {
            task: 'browser-check'
        },
        minimum_width: 700
    };
    
    var consentForm = {
        type: jsPsychHtmlButtonResponse,
        stimulus: consentHTML,
        data: {
            task: 'consent'
        },
        choices: ['Decline and exit', 'Accept and continue'],
    };

    let preload_images = [
        'assets/img/ambiguous-low.png',
        'assets/img/ambiguous-high.png',
        'assets/img/invisible-low.png',
        'assets/img/invisible-high.png',
        'assets/img/attention-check.png',
        'assets/img/countdown-15.gif'
    ];

    stimuliArrays.forEach(item => {                         // Get all stimuli path from stimuliArrays
        preload_images.push(...item.stimuli);
    });

    preload_images = [...new Set(preload_images)];          //Exclude duplicated images just in case

    var preload = {
        type: jsPsychPreload,
        images: preload_images,
        message: `Please wait while the experiment loads. This should take only a moment.`
    };

    var intro1 = {
        type: jsPsychHtmlButtonResponse,
        data: {
            task: 'instructions',
        },
        choices: ['Next'],
        stimulus: html_intro1
    };

    var intro2 = {
        type: jsPsychHtmlButtonResponse,
        data: {
            task: 'instructions',
        },
        choices: ['Next'],
        stimulus: html_intro2
    };

    var initialInstruction = {
            type: jsPsychHtmlButtonResponse,
            stimulus: function() {
                return `<div class="text-container"><h3>On the next page, you will view a few Google Streetview images taken at random from a single town.</h3><br></div>`;
            },
            choices: ['Next'],
    };



/******** MAIN EXPERIMENT **********
************************************
************************************
************************************
************************************/
    
    var current_trial_count = 1;  
    
    function make_trial_block(stimuli_array, item) {

        var sub_timeline_main_experiment = [];      // sub_timeline_main_experiment contains all the main experiment trials
        
        // Add an instruction slide at the beginning of each block
        sub_timeline_main_experiment.push({
            type: jsPsychHtmlButtonResponse,
            stimulus: function() {
                return `<div class="text-container"><h3>Click next to see the next town.</h3></div></div><br>`; //<br>Trial: ${current_trial_count++} / 16
            },
            choices: ['Next']
        })

        // Iterate over the stimuli array to create a series of image slideshow trials.
        for (var i = 0; i < stimuli_array.length; i++) {
            sub_timeline_main_experiment.push(run_present_svSlideshow(stimuli_array[i], item));
        }

        // Function to display a single image in a slideshow format.
        function run_present_svSlideshow(img) {
            var present_svSlideshow = {
                type: jsPsychImageButtonResponse,
                data: {
                    task: 'street view slide show',
                    condition: item.group, // Add condition data
                    cluster: item.cluster, // Add pair_in_condition data
                    country: item.country, // Add state data
                },
                stimulus: img,
                trial_duration: 1000, //1000
                choices: [],
                on_start: function() {
                    console.log("Current stimulus:", img);
                },
            };
            return present_svSlideshow;
        };
            
        // Function to create a prompt with street view images.
        function create_prompt(message, stimuliArray) {
            let prompt_init = `<div style="max-width:95%; min-height: 5em; margin-top: 15px; text-align: center;">`;
                prompt_init += message + '<br><br>';
                    for (let stimulus of stimuli_array) {
                        prompt_init += `<img src='${stimulus}' class="zoomable-image" width=18% height=auto; style="padding: 5px;">`;
                    }
                    prompt_init += "</div>";
                    return prompt_init;
        }

        // Combine the final prompt with the survey
    const finalPrompt = create_prompt(
        "Take a look at all the street view images together:",
        stimuli_array
    );

    sub_timeline_main_experiment.push({
        type: jsPsychSurvey,
        button_label_finish: "Continue",
        data: {
            task: "landscape",
            trial_id: item.cluster,
        },
        pages: [
            [
                {
                    name: "prompt",
                    type: "html",
                    prompt: `
                        <div style="text-align: center;">
                            ${finalPrompt}
                            <p>Answer the following questions based on the images above:</p>
                        </div>
                    `,
                },
                {
                type: "likert",
                name: "ambiguous",
                prompt: "How ambiguous is the boundary of each object?",
                likert_scale_min_label: "Distinct, Clear",
                likert_scale_max_label: "Ambiguous, Unclear",
                likert_scale_values: [1, 2, 3, 4, 5],
                required: false,
            },
            {
                type: "likert",
                name: "objects",
                prompt: "How many different objects do there seem to be?",
                likert_scale_min_label: "Relatively few",
                likert_scale_max_label: "Enormous number",
                likert_scale_values: [1, 2, 3, 4, 5],
                required: false,
            },
            {
                type: "likert",
                name: "invisible",
                prompt: "To what degree do there seem to be parts of the scene that are invisible?",
                likert_scale_min_label: "Few invisible parts",
                likert_scale_max_label: "Many invisible parts",
                likert_scale_values: [1, 2, 3, 4, 5],
                required: false,
            },
            {
                type: "likert",
                name: "chaos",
                prompt: "To what degree is the scene either organized or chaotic?",
                likert_scale_min_label: "Organized",
                likert_scale_max_label: "Chaotic",
                likert_scale_values: [1, 2, 3, 4, 5],
                required: false,
            },
            {
                type: "likert",
                name: "complex",
                prompt: "How complex is this image?",
                likert_scale_min_label: "Simple",
                likert_scale_max_label: "Complex",
                likert_scale_values: [1, 2, 3, 4, 5],
                required: false,
            },
            ],
        ],
    });
        
        return sub_timeline_main_experiment;
    };

    var half_way = {
        type: jsPsychHtmlButtonResponse,
        data: {
            task: 'half-way'
        },
        stimulus: half_way_prompt,
        choices: ['Next'],
        trial_duration: 15750
    };



    // END OF EXPERIMENT
    function selfDescribe() {
        a = document.getElementById('self-describe');
        a.checked = true;
    };

    function selfDescribeRace() {
        a = document.getElementById('self-describe-race');
        a.checked = true;
    };

    var demogFormFormat = "<p>Please complete this section with your demographic information:</p>";
    var final_html = "<p>Thank you for participating in this study!</p>";

    var demogForm1 = {
        type: jsPsychSurveyHtmlForm,
        data: {
            task: 'demographics1'
        },
        preamble: preambleDemog,
        html: demogForm1,
        choices: ['Next'],
    };

    // var demogForm2 = {
    //     type: jsPsychSurvey,
    //     button_label_finish: "Next",
    //     data: {
    //         task: 'demographics2'
    //     },
    //     pages: [
    //             /*[
    //                 {
    //                     type: 'html',
    //                     prompt: demogFormFormat,
    //                     name: 'format_skip',
    //                 },
    //                 {
    //                     type: 'multi-choice',
    //                     prompt: "What is the highest education you've completed?",
    //                     options: [
    //                         'Some high school',
    //                         'High school diploma or equivalent',
    //                         'Some college',
    //                         'Associate’s degree',
    //                         'Bachelor’s degree',
    //                         'Graduate & professional degrees'
    //                     ],
    //                     name: 'education',
    //                 },
    //             ],*/  
    //             [
    //                 {
    //                     type: 'html',
    //                     prompt: demogFormFormat,
    //                     name: 'format_skip',
    //                 }, 
    //                 {
    //                     type: 'multi-choice',
    //                     prompt: "How would you describe your political orientation?",
    //                     options: [
    //                         "Very Liberal",
    //                         "Liberal",
    //                         "Moderate",
    //                         "Conservative",
    //                         "Very Conservative"
    //                     ],
    //                     name: "ideology",
    //                 },
    //             ], 
    //             [
    //                 {
    //                     type: 'html',
    //                     prompt: demogFormFormat,
    //                     name: 'format_skip',
    //                 }, 
    //                 {
    //                     type: 'text',
    //                     prompt: "How many times during your childhood did you move to a totally new neighborhood or town?",
    //                     name: 'num-moves',
    //                     textbox_columns: 5,
    //                     input_type: 'number'
    //                 },
    //             ],
    //             [
    //                 {
    //                     type: 'html',
    //                     prompt: final_html,
    //                     name: 'format_skip',
    //                 }, 
    //                 {
    //                     type: 'likert-table',
    //                     name: 'SDO',
    //                     prompt: ' ',
    //                     randomize_statement_order: true,
    //                     statements: [
    //                         {prompt: "An ideal society requires some groups to be on top and others to be on the bottom.", name: 'PDom_1'},
    //                         {prompt: "Some groups of people are simply inferior to other groups.", name: "PDom_2",},
    //                         {prompt: "No one group should dominate in society.", name: 'CDom_1'},
    //                         {prompt: "Groups at the bottom are just as deserving as groups at the top.", name: 'CDom_2'},
    //                         {prompt: "Group equality should not be our primary goal.", name: 'PAE_1'},
    //                         {prompt: "It is unjust to try to make groups equal.", name: 'PAE_2'},
    //                         {prompt: "We should do what we can to equalize conditions for different groups.", name: 'CAE_1'},
    //                         {prompt: "We should work to give all groups an equal chance to succeed.", name: 'CAE_2'},
    //                     ],
    //                     options: [
    //                         "Strongly Oppose",
    //                         "Somewhat Oppose",
    //                         "Slightly Oppose",
    //                         "Neutral",
    //                         "Slightly Favor",
    //                         "Somewhat Favor",
    //                         "Strongly Favor",
    //                     ],
    //                 }
    //             ],
    //             /*[
    //                 {
    //                     type: 'html',
    //                     prompt: demogFormFormat + `
    //                     <div class="text-container">
    //                         <p style="text-align: left;">
    //                             Think of this ladder as representing where people stand in the United States. At the top of the ladder are the people who are the best off – those who have the most money, the most education, and the most respected jobs. At the bottom are the people who are the worst off – those who have the least money, least education, the least respected jobs, or no job. The higher up you are on this ladder, the closer you are to the people at the very top; the lower you are, the closer you are to the people at the very bottom.
    //                         </p>
    //                         <img src="assets/img/ladder_marked.png" style="max-width: 150px;">
    //                     </div>
    //                     `,
    //                     name: 'format_skip',
    //                 },
    //                 {
    //                     type: 'likert',
    //                     prompt: "Where would you place yourself on this ladder?",
    //                     name: 'social-ladder',
    //                     likert_scale_min: 1,
    //                     likert_scale_max: 10
    //                 }
    //             ]*/
    //         ]
    // };


    
/***********************************
*********** END OF STUDY************
************************************
************************************/
    var endSurveyDebrief = {
        type: jsPsychSurveyText,
        data: {
            task: 'end-survey'
        },
        preamble: debriefHTML,
        questions: [
            {
                prompt: 'Do you have any comments on the study you’d like to share?',
                rows: 8,
                columns: 80,
                name: 'comment',
            }
        ],
        // on_finish: function(data){
        //     data.num_attention_checks_correct = num_attention_checks_correct;
        // },
    };

    var endRedirect_prompt = "<p>Thank you for completing the study! Please click 'Continue' to finish and receive credit.</p>";

    var endRedirect = {
        type: jsPsychHtmlButtonResponse,
        data: {
            task: 'end-survey',
        },
        stimulus: endRedirect_prompt, 
        choices: ['Continue']
    };
    
    var pavlovia_finish = {
        type: jsPsychPavlovia,
        data: {
            task: 'pavlovia-finish'
        },
        command: "finish",
        participantId: pavlovia_id
    };
    
    

/***********************************
************* TIMELINE *************
************************************
************************************/
    timeline.push(browserCheck);
    timeline.push(consentForm);
    timeline.push(preload);
    timeline.push(intro1);
    timeline.push(intro2);

    timeline.push(initialInstruction);
    data.forEach((item, index) => {
        var sub_timeline_main_experiment = make_trial_block(item.stimuli_array, item);
        timeline.push(...sub_timeline_main_experiment);
        if (index === Math.floor(data.length / 2) - 1) {
            timeline.push(half_way);
        }
    });

    timeline.push(demogForm1);
    //timeline.push(demogForm2);
    timeline.push(endSurveyDebrief);
    // Recommend this object is **BEFORE** the trial to redirect for completion or display code
    timeline.push(endRedirect);
    timeline.push(pavlovia_finish);
    
    // start the experiment
    jsPsych.run(timeline);

</script>
